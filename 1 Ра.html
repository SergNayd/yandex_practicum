#!/usr/bin/env python
# coding: utf-8

# #  Разработка стратегии взаимодействия с клиентами Сети фитнес-центров «Культурист-датасаентист»   на основе аналитических данных.
# 
# # Описание проекта
# 
# Сеть фитнес-центров «Культурист-датасаентист» разрабатывает стратегию взаимодействия с клиентами на основе аналитических данных. Распространённая проблема фитнес-клубов  — отток клиентов. Как понять, что клиент больше не с вами? Можно записать в отток тех, кто попросил закрыть договор или удалил аккаунт.  Чтобы бороться с оттоком, отдел по работе с клиентами «Культуриста-датасаентиста» перевёл в электронный вид множество клиентских анкет. На основе этих данных проанализируем действия клиентов фитнес-центров.
# 
# #    Задачи
# 
# - научиться прогнозировать вероятность оттока (на уровне следующего месяца) для каждого клиента;
# - сформировать типичные портреты клиентов: выделить несколько наиболее ярких групп и охарактеризовать их основные свойства;
# - проанализировать основные признаки, наиболее сильно влияющие на отток;
# - сформулировать основные выводы и провести анализ и подготовить план действий по удержанию клиентов:
#     1) выделить целевые группы клиентов;
#     2) предложить меры по снижению оттока;
#     3) определить другие особенности взаимодействия с клиентами.
# 
# 
# #  Описание данных
# 
# - Текущие поля в датасете:
#     - Данные клиента за предыдущий до проверки факта оттока месяц:
#         - `'gender'` — пол;
#         - `'Near_Location'` — проживание или работа в районе, где находится фитнес-центр;
#         - `'Partner'` — сотрудник компании-партнёра клуба (сотрудничество с компаниями, чьи сотрудники могут получать скидки на абонемент — в таком случае фитнес-центр хранит информацию о работодателе клиента);
#         - `Promo_friends` — факт первоначальной записи в рамках акции «приведи друга» (использовал промо-код от знакомого при оплате первого абонемента);
#         - `'Phone'` — наличие контактного телефона;
#         - `'Age'` — возраст;
#         - `'Lifetime'` — время с момента первого обращения в фитнес-центр (в месяцах).
# - Информация на основе журнала посещений, покупок и информация о текущем статусе абонемента клиента:
#     - `'Contract_period'` — длительность текущего действующего абонемента (месяц, 3 месяца, 6 месяцев, год);
#     - `'Month_to_end_contract'` — срок до окончания текущего действующего абонемента (в месяцах);
#     - `'Group_visits'` — факт посещения групповых занятий;
#     - `'Avg_class_frequency_total'` — средняя частота посещений в неделю за все время с начала действия абонемента;
#     - `'Avg_class_frequency_current_month'` — средняя частота посещений в неделю за предыдущий месяц;
#     - `'Avg_additional_charges_total'` — суммарная выручка от других услуг фитнес-центра: кафе, спорт-товары, косметический и массажный салон.
#     - `'Churn'` — факт оттока в текущем месяце;

# ##    Загрузка данных

# In[155]:


import pandas as pd
import math as mth
import matplotlib.pyplot as plt
from scipy import stats as st
#from google.colab import files
import numpy as np

#визуализация
import seaborn as sns; sns.set()


#ML
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split

from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score

from sklearn.tree import DecisionTreeRegressor, DecisionTreeClassifier
from sklearn.ensemble import RandomForestRegressor, GradientBoostingRegressor
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier
from sklearn.metrics import accuracy_score, precision_score, recall_score
from sklearn.cluster import KMeans
from scipy.cluster.hierarchy import dendrogram, linkage

#доп настройки
pd.options.display.expand_frame_repr = False
import warnings
warnings.filterwarnings('ignore')  


# In[156]:


# открываем файлы
fitnes = pd.read_csv('/datasets/gym_churn.csv', sep=',')

# смотрим общую информацию
display(fitnes.head())
fitnes.info()


# В нашей таблице 14 колонок и 4000 строк в каждом столбце:
# * `gender` типа int64
# * `Near_Location` типа int64, 
# * `Partner типа` тип int64, 
# * `Promo_friends` тип int64, 
# * `Phone` тип int64, 
# * `Contract_period` тип int64, 
# * `Group_visits` тип int64, 
# * `Age` тип int64, 
# * `Avg_additional_charges_total` тип float64, 
# * `Month_to_end_contract` тип float64, 
# * `Lifetime` тип int64, 
# * `Churn` тип int64, 
# * `Avg_class_frequency_total` тип float64
# * `Avg_class_frequency_current_month` тип float64. 
# 
# Пропусков нет, данные корректны.

# ##  Проведём исследовательский анализ данных (EDA)

# ### Посмотрим на датасет: есть ли в нем отсутствующие признаки, изучим средние значения и стандартные отклонения (пригодится метод describe())

# In[157]:


# названия столбцов приведём к нижнему регистру
fitnes.columns = fitnes.columns.str.lower()
# проверим
fitnes.head()


# In[158]:


# проверим на дубликаты
fitnes[fitnes.duplicated()]


# дубликатов строк нет

# In[159]:


# метод describe()
fitnes['gender'].describe()


# По полу - распределение  почти 50 на 50

# In[160]:


fitnes['near_location'].describe()


# По проживанию - 84% клиентов проживают или работают в районе, где находится фитнес-центр

# In[161]:


fitnes['partner'].describe()


# Компании-партнёра клуба - почти половина клиентов из выборки 48% - это сотрудники компании-партнёра

# In[162]:


fitnes['promo_friends'].describe()


# Акции «приведи друга» - 30% клиентов те, кто использовал промо-код от знакомого или друга

# In[163]:


fitnes['phone'].describe()


# Наличие указанного контактного телефона - у 90% клиентов

# In[164]:


fitnes['age'].describe()


# Возраст клиентов:
# * максимальный 41 год, 
# * среднее значение возраста рядм с медианой - 29 лет
# * минимальный возраст клиентов - 18 лет.

# In[165]:


fitnes['lifetime'].describe()


# Время с момента первого обращения:
# * максимальное значение - 31 месяц, около 3х лет
# * большинство около 3 - 5 месяцев

# In[166]:


fitnes['contract_period'].describe()


# Длительность текущего действующего абонемента у клиентов фитнеса - среднее от 4 до 5 месяцев, медиана 1 месяц.

# In[167]:


fitnes['month_to_end_contract'].describe()


# Срок до окончания текущего действующего абонемента - средний 4 месяца, медианное значение - 1 месяц.

# In[168]:


fitnes['group_visits'].describe()


# Факт посещения групповых занятий - прослеживаются у 41% клиентов 

# In[169]:


fitnes['avg_class_frequency_total'].describe()


# Средняя частота посещений в неделю за все время с начала действия абонемента - 2 раза. Максимальное значение - 6 дней в неделю.

# In[170]:


fitnes['avg_class_frequency_current_month'].describe()


# Средняя частота посещений в неделю за предыдущий месяц -  1-2 раза. Максимальное значение - 6 дней в неделю.

# In[171]:


fitnes['avg_additional_charges_total'].describe()


# суммарная выручка от других услуг фитнес-центра: кафе, спорттовары, косметический и массажный салон:
# * в среднем составляет 147 у.е.,
# * медианное значение близко к среднему - 136 у.е. 
# * максимальный  - 552,5 у.е.

# In[172]:


fitnes['churn'].describe()


# Факт оттока в текущем месяце - составил 26,5%

# In[173]:


# средние значения и стандартные отклонения всех признаков
fitnes.agg(['mean','std'])


# Большое стандартное отклонение у колонки Price (суммарная выручка на дополнительные услуги) - 96.3. 
# 
# У остальные признаков страндартные отклонения в нормальных пределах.

# #### Предварительный вывод:
# * По полу - распределение почти 50 на 50
# * По проживанию - 84% клиентов проживают или работают в районе, где находится фитнес-центр
# * Компании-партнёра клуба - почти половина клиентов из выборки 48% - это сотрудники компании-партнёра
# * Акции «приведи друга» - 30% клиентов те, кто использовал промо-код от знакомого или друга
# * Наличие указанного контактного телефона - у 90% клиентов
# * Возраст клиентов:
#     - максимальный 41 год,
#     - среднее значение возраста рядм с медианой - 29 лет
#     - минимальный возраст клиентов - 18 лет.
# * Время с момента первого обращения:
#     - максимальное значение - 31 месяц, около 3х лет
#     - большинство около 3 - 5 месяцев    
# * Длительность текущего действующего абонемента у клиентов фитнеса - среднее от 4 до 5 месяцев, медиана 1 месяц.
# * Срок до окончания текущего действующего абонемента - средний 4 месяца, медианное значение - 1 месяц.
# * Факт посещения групповых занятий - прослеживаются у 41% клиентов
# * Средняя частота посещений в неделю за все время с начала действия абонемента - 2 раза. Максимальное значение - 6 дней в неделю.
# * Суммарная выручка от других услуг фитнес-центра: кафе, спорттовары, косметический и массажный салон:
#     - в среднем составляет 147 у.е.,
#     - медианное значение близко к среднему - 136 у.е.
#     - максимальный - 552,5 у.е.
# * Факт оттока в текущем месяце - составил 26,5%    

# ### Посмотрим на средние значения признаков в двух группах — тех, кто ушел в отток и тех, кто остался (воспользуемся методом groupby())

# In[174]:


fitnes.groupby('churn')['gender'].agg('count')


# Отток клиентов - 1061 человек, остались 2939 человек.

# In[175]:


fitnes.groupby('churn').agg('mean')


# #### Промежуточный вывод:
# 
# * Отток клиентов - 1061 человек, остались 2939 человек.
# * По полу распределение равное среди оставших и ушедших почти 50 на 50
# * 76% ушедших жили или работали в районе фитнес-центра
# * 18% ушедших первоначально записывались в рамках акции «приведи друга»
# * Признак наличия в базе телефонного номера тоже не отличатся (90%) для обеих групп
# * Среди ушедших только 26% посещали групповые занятие, а среди оставшихся таких 46%.
# * Ушедшие - люди с небольшим перодом контракта 1-2 месяца. У оставшихся периодом контракта 5-6 месяцев
# * Возраст в обеих группах (26-30 лет)
# * Траты на другие услуги фитнес-центра - среди ушедших средние траты были примерно 115 у.е, а среди оставшихся - 158 у.е.
# * Среди ушедших средний `lifetime` с момента первого обращения в фитнес-центр - меньше месяца. Есть проблемы с удержанием клиентов
# * Средняя частота посещений в неделю за предыдущий месяц у тех кто ушёл 1 раз в неделю. у оставшихся - 2 раза в неделю
# 
#     Остаются клиенты с более длительным сроком абонемента.
# 

# ### Построим столбчатые гистограммы и распределения признаков для тех, кто ушёл (отток) и тех, кто остался (не попали в отток)

# In[176]:


left = fitnes[fitnes['churn']==1]
stayed = fitnes[fitnes['churn']==0]
distplot_columns = ['avg_additional_charges_total', 'avg_class_frequency_total', 
                    'avg_class_frequency_current_month', 'lifetime', 'age', 
                    'contract_period', 'month_to_end_contract']
for column in distplot_columns: 
    plt.figure(figsize=(10,4)) 
    plt.title(column)
    sns.distplot(left[column])
    sns.distplot(stayed[column])
    plt.legend(['Отток', 'Оставшиеся'])
    plt.show()


# In[177]:


for column in fitnes.columns:
    if column not in distplot_columns:
        fitnes.groupby('churn')[column].hist()
        plt.title(column)
        plt.legend(['Оставшиеся', 'Отток'])
        plt.show()


# Данные по графикам подтверждают наши прошлые выводы

# ### Построим матрицу корреляций и отобразите её

# In[178]:


plt.figure(figsize=(14,10))
sns.heatmap(data = fitnes.corr(), annot=True, square=True, cmap='YlGnBu')
plt.title('Матрица корреляций')
plt.show()


# #### Промежуточный вывод:
# 
# Зависимости факта оттока клиентов от признаков не видно.
# 
# Заметны два мультиколлинеарных признака 0,97:
# * `contract_period`  длительность текущего действующего абонемента
# * `month_to_end_contact` срок до окончания текущего действующего абонемента
# 
# И два мультиколлинеарных признака 0,95:
# * `Avg_class_frequency_total` — средняя частота посещений в неделю за все время с начала действия абонемента
# * `Avg_class_frequency_current_month` — средняя частота посещений в неделю за предыдущий месяц

# ## Построим модель прогнозирования оттока клиентов

# ### Построим модель бинарной классификации клиентов, где целевой признак — факт оттока клиента в следующем месяце

# In[179]:


X = fitnes.drop(['churn'], axis = 1)
y = fitnes['churn']
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=0)
scaler = StandardScaler()
X_train_st = scaler.fit_transform(X_train)
X_test_st = scaler.transform(X_test)

lr_model = LogisticRegression(random_state=0)
lr_model.fit(X_train_st, y_train)
lr_predictions = lr_model.predict(X_test_st)
lr_probabilities = lr_model.predict_proba(X_test_st)[:,1]
print('Метрики модели логистической регрессии:')
print('accuracy_score: {}\nprecision_score: {}\nrecall_score:{}'.format(
    accuracy_score(y_test, lr_predictions),
    precision_score(y_test, lr_predictions),
    recall_score(y_test, lr_predictions)
))

rf_model = RandomForestClassifier(n_estimators = 100, random_state = 0) 
rf_model.fit(X_train_st, y_train)
rf_predictions = rf_model.predict(X_test_st)
rf_probabilities = rf_model.predict_proba(X_test_st)[:,1]
print('\nМетрики модели случайного леса:')
print('accuracy_score: {}\nprecision_score: {}\nrecall_score:{}'.format(
    accuracy_score(y_test, rf_predictions),
    precision_score(y_test, rf_predictions),
    recall_score(y_test, rf_predictions)
))

features = pd.DataFrame(lr_model.coef_.T, X.columns).reset_index()
features.columns = ['feature', 'coef']
features['coef'] = features['coef'].apply(lambda x: abs(x))
features = features.sort_values(by='coef', ascending=False)
print('\nКоэффициенты признаков в оптимальной функции логистической регрессии:')
print(features)


# In[180]:


# стратифицировать выборки по таргету с помощью параметра stratify
#X_train, X_test, y_train, y_test = train_test_split(X, y, 
                                                    #train_size=0.67, 
                                                    #random_state=42,
                                                    #stratify=y)

#print(f"Количество строк в y_train по классам: {np.bincount(y_train)}")
#print(f"Количество строк в y_test по классам: {np.bincount(y_test)}")


# #### Промежуточный вывод:
# 
# * Модель логистической регрессии дала наилучшие метрики - доля правильных прогнозов и полнота немного выше 
# * Это значит, что в бинарной классификации модель логистической регрессии показывает себя фаворитом.

# ### Сделаем кластеризацию клиентов

# #### Проведем кластеризацию пользователей без столбца целевого значения
# 
#     Стандартизируем данные
#     Построим матрицу расстояний функцией linkage() на стандартизированной матрице признаков, нарисуем дендограмму. Предположим, какое количество кластеров можем выделить.
#     Обучим модель кластеризации на основе алгоритма K-Means и спрогнозируем кластеры клиентов (Договоримся за число кластеров принять n=5)

# In[181]:


#sc = StandardScaler()
X_st = scaler.fit_transform(X)

linked = linkage(X_st, method='ward')

plt.figure(figsize=(15, 10))
dendrogram(linked, orientation='top')
plt.title('\n Иерархическая кластеризация', fontsize=15)
plt.show()

km = KMeans(n_clusters = 5, random_state = 0)
labels = km.fit_predict(X_st)
fitnes['cluster_km'] = labels


# #### Промежуточный вывод:
# 
# * Видим 4 (цвета)- кластера
# * Нам по ТЗ нужно использовать 5 кластеров

# ### Посмотрим на средние значения признаков для кластеров. Можно ли сразу что-то заметить?

# In[182]:


fitnes.groupby('cluster_km').mean()


# ### Построим распределения признаков для кластеров.

# In[183]:


for value in [0, 1, 2, 3, 4]:
    fitnes[fitnes['cluster_km']==value].hist(figsize=(17,10))
    plt.suptitle('\nРаспределение признаков для кластера {}'.format(value), fontsize = 15)
    plt.show()


# #### Промежуточный вывод:
# 
#  Что мы видим по кластерам:
# 
# *  0
#     - отток около 3% - самый низкий
#     - живут или работают недалеко 
#     - клиенты сотрудники компаний-партнеров - 57%
#     - длительный срок контрактов - 10 месяцев
#     - часто ходят на групповые занятия - 54%
#     - чаще визит в первый раз по промо-акции 57%
#     
# *  1
#     - отток 27%
#     - живут или работают недалеко
#     - нет мобильного номера в базе данных
#     - клиенты сотрудники компаний-партнеров - 47%
#     - срок контрактов в среднем - 4,5 месяцев 
#     - посещение групповых занятий - 42%
#     - визит в первый раз по промо-акции 30%
#     
#     
# *  2
#     - отток - 44%
#     - клиенты сотрудники компаний-партнеров - 46%
#     - срок контрактов в среднем - 2 месяца
#     - посещение групповых занятий низкий - 21%
#     - пришли по промо акции - 7%
#     - редко посещают групповые занятия
#     
# *  3
#     - отток - 51% - самый высокий
#     - Живут или работают недалеко от фитнес-центра
#     - клиенты сотрудники компаний-партнеров - 35%
#     - срок контрактов в среднем - 2 месяца
#     - посещение групповых занятий низкий - 34%
#     - В основном обладатели недолгосрочных абонементов на 1-2 месяца
#     - меньше всех посещений за всё время 1,1 и в текущий месяц 1
#     
#     
# *  4
#     - Отток - 7%
#     - Живут или работают недалеко от фитнес-центра
#     - клиенты сотрудники компаний-партнеров - 35%
#     - срок контрактов в среднем - 2.5 месяца
#     - посещение групповых занятий  - 47%
#     - чаще всех посещают клуб - 2.85 раз в неделю    

# ### Для каждого полученного кластера посчитайте долю оттока (методом groupby())

# In[184]:


# считаем долю оттока
churn_share = fitnes.groupby('cluster_km')['churn'].agg('sum') / fitnes.groupby('cluster_km')['churn'].size()
display(churn_share)


# * Кластеры 2 и 3 склонны к оттоку (44 - 51% клиентов ушло)
# * Кластеры 0 и 4 более надёжны (ушло только 2% и 6% клиентов соответственно).

# ## Выводы и рекомендации.

# ### Мы провели анализ данных о клиентах сети фитнес-центров «Культурист-датасаентист»

# ### Выводы на основе данных - признаков у клиентов, попавших в отток и оставшихся:
# 
# * Распределение по полу 50/50
# * Сотрудники компаний-партнеров лучше посещают фитнесс-клуб 
# * Акция "Приведи друга" работает - эти клиенты реже уходят в отток
# * Средняя длительность договора больше у оставшихся пользователей и они же чаще ходят на групповые занятия
# * Ближе живущие или работающие клиенты реже попадают в отток
# * Кол-во посещений в предыдущий месяц в два раза ниже у клиентов в оттоке

# ### Рекомендации:
# 
# Лучше сосредоточить ресурсы и усилия на клиентах из кластера 3 (живут близко к фитнесу, но самый большой отток):
# * Продавать больше долгосрочных абонементов - на них отток ниже
# * Активно привлекать в групповые занятия - Новые тренинг-программы, новшества мирового фитнеса  и собственные идеи с разным спортинвентарём
# 
#  
# * Индивидуальный подход к клиентам - необходимо привлечь более молодых и более пожилых людей в мир фитнеса:
#     - В мире очень популярен фитнес у старшего возраста, например в Китае
#     - Клиентам живущим далеко - на удержание таких клиентов следует направить больше усилий (скидки, промо-акции групповых занятий)
#     - Создать такие условия в клубе, чтобы клиенты ощущали чувство команды и узнаваемости бренда, тем самым гордиться принадлежности к этому клубу.
#      
